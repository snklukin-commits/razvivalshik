<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–æ–∏—Å–∫ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø–æ–º–µ—â–µ–Ω–∏–π</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 28px;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    .header p {
      color: #7f8c8d;
      font-size: 14px;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .control-group {
      background: white;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .control-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #34495e;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .control-group input,
    .control-group select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #ecf0f1;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .control-group input:focus,
    .control-group select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .btn-group {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #3498db;
      color: white;
      flex: 1;
    }

    .btn-primary:hover {
      background: #2980b9;
      box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
    }

    .btn-success {
      background: #27ae60;
      color: white;
      flex: 1;
    }

    .btn-success:hover {
      background: #229954;
      box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
      flex: 1;
    }

    .btn-secondary:hover {
      background: #7f8c8d;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
      padding: 10px 16px;
      font-size: 14px;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      background: #3498db;
      color: white;
    }

    .btn-small:hover {
      background: #2980b9;
    }

    .btn-remove {
      padding: 8px 12px;
      font-size: 12px;
      background: #e74c3c;
      color: white;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .btn-remove:hover {
      background: #c0392b;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 16px;
      color: white;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .card-header:hover {
      opacity: 0.9;
    }

    .card-header h3 {
      font-size: 16px;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .card-header p {
      font-size: 12px;
      opacity: 0.9;
    }

    .card-body {
      padding: 16px;
    }

    .card-field {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #ecf0f1;
    }

    .card-field:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .card-field-label {
      font-size: 11px;
      font-weight: 600;
      color: #7f8c8d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .card-field-value {
      font-size: 14px;
      color: #2c3e50;
      line-height: 1.4;
      word-break: break-word;
    }

    .competitor-item {
      background: #f8f9fa;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 6px;
      font-size: 13px;
      line-height: 1.3;
    }

    .competitor-item:last-child {
      margin-bottom: 0;
    }

    .anchor-item {
      background: #f0f7ff;
      padding: 10px;
      border-radius: 4px;
      font-size: 13px;
      line-height: 1.4;
      border-left: 3px solid #3498db;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .badge-danger {
      background: #ffe5e5;
      color: #c0392b;
    }

    .badge-success {
      background: #d5f4e6;
      color: #27ae60;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-info {
      background: #d6eaf8;
      color: #2980b9;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #2c3e50;
      padding-bottom: 12px;
      border-bottom: 2px solid #ecf0f1;
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #34495e;
      margin-bottom: 6px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #ecf0f1;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .competitors-list {
      margin-bottom: 16px;
    }

    .competitor-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 8px;
      margin-bottom: 8px;
      align-items: end;
    }

    .competitor-row input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ecf0f1;
      border-radius: 4px;
      font-size: 12px;
    }

    .competitor-row input:focus {
      outline: none;
      border-color: #3498db;
    }

    .competitor-actions {
      display: flex;
      gap: 4px;
    }

    .anchor-toggle {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
    }

    .anchor-toggle label {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 0;
      font-size: 14px;
      font-weight: 400;
    }

    .anchor-fields {
      display: grid;
      gap: 12px;
    }

    .anchor-fields > div {
      display: grid;
      gap: 4px;
    }

    .anchor-fields input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #ecf0f1;
      border-radius: 6px;
      font-size: 14px;
    }

    .modal-footer {
      display: flex;
      gap: 8px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #ecf0f1;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state p {
      color: #7f8c8d;
      margin-bottom: 16px;
    }

    .link {
      color: #3498db;
      text-decoration: none;
      transition: color 0.2s;
    }

    .link:hover {
      color: #2980b9;
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .cards-grid {
        grid-template-columns: 1fr;
      }

      .competitor-row {
        grid-template-columns: 1fr;
      }

      .controls {
        grid-template-columns: 1fr;
      }
    }
  </style>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        window.places = []; 
        window.isFirebaseReady = false;

        const firebaseConfig = {
          apiKey: "AIzaSyCXU_qtA65zudpgUsdNdbndOSpuGRbEJ2c",
          authDomain: "pharmacy-manager-d7802.firebaseapp.com",
          projectId: "pharmacy-manager-d7802",
          storageBucket: "pharmacy-manager-d7802.firebasestorage.app",
          messagingSenderId: "60028648458",
          appId: "1:60028648458:web:45e2a124ea3b7d7c46f3f3",
        };

        try {
            firebase.initializeApp(firebaseConfig);
            var db = firebase.firestore();
        } catch(e) { console.error("Firebase Init Fail", e); }

        const DOC_REF = db.collection("pharmacy_app").doc("search_premises");

        function setStatus(msg, color) {
            let el = document.getElementById('syncStatus');
            if (!el) {
                // Try to inject
                const header = document.querySelector('h2');
                if(header) {
                     const div = document.createElement('div');
                     div.innerHTML = '<span id="syncStatus" style="float:right; font-size:16px; cursor:help;"></span>';
                     header.parentNode.insertBefore(div, header);
                     el = div.querySelector('#syncStatus');
                }
            }
            if(!el) return;

            let icon = 'üîÑ';
            if (msg.includes('–∑–∞–≥—Ä—É–∂–µ–Ω—ã') || msg.includes('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ')) icon = '‚úÖ';
            else if (msg.includes('–û—à–∏–±–∫–∞')) icon = '‚ùå';
            else if (msg.includes('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ')) icon = '‚è≥';
            el.innerHTML = icon;
            el.title = msg;
        }

        window.saveToFirebase = function() {
            if (!window.isFirebaseReady) return;
            setStatus("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...", "orange");
            const data = { places: window.places || [] };
            DOC_REF.set(data, { merge: true })
            .then(() => setStatus("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ", "green"))
            .catch((err) => { setStatus("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "red"); console.error(err); });
        };

        window.initFirebaseSync = function() {
            setStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...", "blue");
            DOC_REF.onSnapshot((doc) => {
                window.isFirebaseReady = true;
                if (doc.exists) {
                    const data = doc.data();
                    window.places = data.places || [];
                    setStatus("–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã", "green");
                } else {
                    setStatus("–ë–∞–∑–∞ –ø—É—Å—Ç–∞", "gray");
                }
                if (typeof renderPlaces === 'function') renderPlaces();
            });
        };
    </script>

<script>window.addEventListener('DOMContentLoaded', initFirebaseSync);</script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        window.places = []; 
        window.isFirebaseReady = false;

        const firebaseConfig = {
          apiKey: "AIzaSyCXU_qtA65zudpgUsdNdbndOSpuGRbEJ2c",
          authDomain: "pharmacy-manager-d7802.firebaseapp.com",
          projectId: "pharmacy-manager-d7802",
          storageBucket: "pharmacy-manager-d7802.firebasestorage.app",
          messagingSenderId: "60028648458",
          appId: "1:60028648458:web:45e2a124ea3b7d7c46f3f3",
        };

        try {
            firebase.initializeApp(firebaseConfig);
            var db = firebase.firestore();
        } catch(e) { console.error("Firebase Init Fail", e); }

        const DOC_REF = db.collection("pharmacy_app").doc("search_premises");

        function setStatus(msg, color) {
            let el = document.getElementById('syncStatus');
            if (!el) {
                const header = document.querySelector('h2');
                if(header) {
                     const div = document.createElement('div');
                     div.innerHTML = '<span id="syncStatus" style="float:right; font-size:16px; cursor:help;"></span>';
                     header.parentNode.insertBefore(div, header);
                     el = div.querySelector('#syncStatus');
                }
            }
            if(!el) return;

            let icon = 'üîÑ';
            if (msg.includes('–∑–∞–≥—Ä—É–∂–µ–Ω—ã') || msg.includes('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ')) icon = '‚úÖ';
            else if (msg.includes('–û—à–∏–±–∫–∞')) icon = '‚ùå';
            else if (msg.includes('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ')) icon = '‚è≥';
            el.innerHTML = icon;
            el.title = msg;
        }

        window.saveToFirebase = function() {
            if (!window.isFirebaseReady) return;
            setStatus("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...", "orange");
            const data = { places: window.places || [] };
            DOC_REF.set(data, { merge: true })
            .then(() => setStatus("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ", "green"))
            .catch((err) => { setStatus("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "red"); console.error(err); });
        };

        window.initFirebaseSync = function() {
            setStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...", "blue");
            DOC_REF.onSnapshot((doc) => {
                window.isFirebaseReady = true;
                if (doc.exists) {
                    const data = doc.data();
                    window.places = data.places || [];
                    setStatus("–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã", "green");
                } else {
                    setStatus("–ë–∞–∑–∞ –ø—É—Å—Ç–∞", "gray");
                }

                // FORCE FILTER "–í —Ä–∞–±–æ—Ç–µ"
                const filterEl = document.getElementById('filterDecision');
                if(filterEl && !window.initFilterDone) {
                    filterEl.value = "–í —Ä–∞–±–æ—Ç–µ";
                    window.initFilterDone = true;
                }

                // CALL RENDER WITHOUT ARGS to force DOM reading
                if (typeof renderPlaces === 'function') renderPlaces();
            });
        };
    </script>

<script>window.addEventListener('DOMContentLoaded', initFirebaseSync);</script>
</head>
<body>
  <div class="container">
<div style="text-align: right; margin-bottom: 5px; height:20px;"><span id="syncStatus"></span></div>
<div style="text-align: right; margin-bottom: 5px; height:20px;"><span id="syncStatus"></span></div>
    <div class="header">
      <h1>üè¢ –ü–æ–∏—Å–∫ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø–æ–º–µ—â–µ–Ω–∏–π</h1>
      <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–º–µ—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∞–ø—Ç–µ–∫</p>
    </div>

    <div class="controls">
      <div class="control-group">
        <label>–ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É</label>
        <input type="text" id="searchAddress" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å..." onkeyup="applyFilters()">
      </div>
      <div class="control-group">
        <label>–§–∏–ª—å—Ç—Ä –ø–æ —Ä–∞–π–æ–Ω—É</label>
        <select id="filterDistrict" onchange="applyFilters()">
          <option value="">–í—Å–µ —Ä–∞–π–æ–Ω—ã</option>
          <option value="–õ–µ–Ω–∏–Ω—Å–∫–∏–π">–õ–µ–Ω–∏–Ω—Å–∫–∏–π</option>
          <option value="–°–æ—Ä–º–æ–≤—Å–∫–∏–π">–°–æ—Ä–º–æ–≤—Å–∫–∏–π</option>
          <option value="–ö–∞–Ω–∞–≤–∏–Ω—Å–∫–∏–π">–ö–∞–Ω–∞–≤–∏–Ω—Å–∫–∏–π</option>
          <option value="–°–æ–≤–µ—Ç—Å–∫–∏–π">–°–æ–≤–µ—Ç—Å–∫–∏–π</option>
          <option value="–ü—Ä–∏–æ–∫—Å–∫–∏–π">–ü—Ä–∏–æ–∫—Å–∫–∏–π</option>
          <option value="–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∏–π">–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∏–π</option>
          <option value="–ê–≤—Ç–æ–∑–∞–≤–æ–¥—Å–∫–∏–π">–ê–≤—Ç–æ–∑–∞–≤–æ–¥—Å–∫–∏–π</option>
        </select>
      </div>
      <div class="control-group">
        <label>–§–∏–ª—å—Ç—Ä –ø–æ —Ä–µ—à–µ–Ω–∏—é</label>
        <select id="filterDecision" onchange="applyFilters()">
          <option value="">–í—Å–µ</option>
          <option value="–ü–æ–¥—Ö–æ–¥–∏—Ç">‚úì –ü–æ–¥—Ö–æ–¥–∏—Ç</option>
          <option value="–í —Ä–∞–±–æ—Ç–µ" selected>‚ü≥ –í —Ä–∞–±–æ—Ç–µ</option>
          <option value="–ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç">‚úó –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç</option>
        </select>
      </div>
      <div class="control-group" style="display: flex; gap: 8px; align-items: flex-end;">
        <button class="btn btn-primary" onclick="openAddModal()" style="flex: 1;">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–º–µ—â–µ–Ω–∏–µ</button>
        <button class="btn btn-secondary" onclick="clearFilters()">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </div>

    <div class="cards-grid" id="cardsContainer"></div>
  </div>

  <div class="modal" id="addModal">
    <div class="modal-content">
      <div class="modal-header">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–º–µ—â–µ–Ω–∏–µ</div>
      <div class="modal-body">
        <div class="form-group">
          <label>–ê–¥—Ä–µ—Å *</label>
          <input type="text" id="formAddress" placeholder="—É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 123">
        </div>
        <div class="form-group">
          <label>–†–∞–π–æ–Ω *</label>
          <select id="formDistrict">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω</option>
            <option value="–õ–µ–Ω–∏–Ω—Å–∫–∏–π">–õ–µ–Ω–∏–Ω—Å–∫–∏–π</option>
            <option value="–°–æ—Ä–º–æ–≤—Å–∫–∏–π">–°–æ—Ä–º–æ–≤—Å–∫–∏–π</option>
            <option value="–ö–∞–Ω–∞–≤–∏–Ω—Å–∫–∏–π">–ö–∞–Ω–∞–≤–∏–Ω—Å–∫–∏–π</option>
            <option value="–°–æ–≤–µ—Ç—Å–∫–∏–π">–°–æ–≤–µ—Ç—Å–∫–∏–π</option>
            <option value="–ü—Ä–∏–æ–∫—Å–∫–∏–π">–ü—Ä–∏–æ–∫—Å–∫–∏–π</option>
            <option value="–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∏–π">–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∏–π</option>
            <option value="–ê–≤—Ç–æ–∑–∞–≤–æ–¥—Å–∫–∏–π">–ê–≤—Ç–æ–∑–∞–≤–æ–¥—Å–∫–∏–π</option>
          </select>
        </div>
        <div class="form-group">
          <label>–°—Å—ã–ª–∫–∞</label>
          <input type="url" id="formLink" placeholder="https://...">
        </div>

        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin: 16px 0;">
          <label style="font-weight: 600; color: #34495e; margin-bottom: 12px; display: block;">–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã</label>
          <button class="btn btn-small" onclick="addCompetitorField()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          <div id="competitorsList" class="competitors-list"></div>
        </div>

        <div class="anchor-section">
          <label style="font-weight: 600; color: #34495e; margin-bottom: 12px; display: block;">–Ø–∫–æ—Ä—å (–∫—Ä—É–ø–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–∞—è —Å–µ—Ç—å)</label>
          <div class="anchor-toggle">
            <label>
              <input type="radio" name="anchorType" value="no" onchange="updateAnchorFields()" checked> –ù–µ—Ç
            </label>
            <label>
              <input type="radio" name="anchorType" value="yes" onchange="updateAnchorFields()"> –î–∞
            </label>
          </div>
          <div id="anchorFieldsContainer" style="display: none;">
            <div class="anchor-fields">
              <div>
                <label style="font-size: 12px; margin-bottom: 4px; display: block;">–ù–∞–∑–≤–∞–Ω–∏–µ —è–∫–æ—Ä—è</label>
                <input type="text" id="formAnchorName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ç–∏">
              </div>
              <div>
                <label style="font-size: 12px; margin-bottom: 4px; display: block;">–ü—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å (—á–µ–∫–∏)</label>
                <input type="text" id="formAnchorTraffic" placeholder="5000">
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>–ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å - –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
          <input type="text" id="formLandlordContact" placeholder="–§–ò–û –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–≥–æ –ª–∏—Ü–∞">
        </div>
        <div class="form-group">
          <label>Email –∞—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—è</label>
          <input type="email" id="formLandlordEmail" placeholder="email@example.com">
        </div>
        <div class="form-group">
          <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
          <input type="tel" id="formLandlordPhone" placeholder="+7 (999) 123-45-67">
        </div>
        <div class="form-group">
          <label>–ü–ª–æ—â–∞–¥—å (–º¬≤)</label>
          <input type="text" id="formArea" placeholder="50,0">
        </div>
        <div class="form-group">
          <label>–ê—Ä–µ–Ω–¥–∞ (‚ÇΩ)</label>
          <input type="text" id="formRent" placeholder="50 000">
        </div>
        <div class="form-group">
          <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
          <textarea id="formNotes" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..." rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>–†–µ—à–µ–Ω–∏–µ</label>
          <select id="formDecision">
            <option value="–ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç">‚úó –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç</option>
            <option value="–í —Ä–∞–±–æ—Ç–µ" selected>‚ü≥ –í —Ä–∞–±–æ—Ç–µ</option>
            <option value="–ü–æ–¥—Ö–æ–¥–∏—Ç">‚úì –ü–æ–¥—Ö–æ–¥–∏—Ç</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" onclick="savePlace()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-secondary" onclick="closeAddModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-danger" id="deleteBtn" onclick="deletePlace()" style="display: none; margin-left: auto;">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    let competitors = [];
    let editingId = null;

    window.places = null || [
      {
        id: 1,
        address: "—É–ª. –õ–µ–≤–æ–±–µ—Ä–µ–∂–Ω–∞—è, 3",
        district: "–õ–µ–Ω–∏–Ω—Å–∫–∏–π",
        link: "https://www.avito.ru/nizhniy_novgorod/kommercheskaya_nedvizhimost/torgovaya_ploschad_32_6_7576672665",
        competitors: [
          { address: "—É–ª. –ë–µ—Ä–µ–≥–æ–≤–∞—è, 5", name: "–ú–∞–∫—Å–∞–≤–∏—Ç", distance: "0,2 –∫–º", traffic: "1200" },
          { address: "—É–ª. –ë–µ—Ä–µ–≥–æ–≤–∞—è, 10", name: "–ê–ø—Ç–µ—á–µ—Å—Ç–≤–æ", distance: "0,2 –∫–º", traffic: "850" }
        ],
        area: "32,6",
        rent: "65 200",
        anchor: null,
        notes: "–°–ø–∞–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω '–ê–∫–≤–∞–º–∞—Ä–∏–Ω' (8 –º–Ω–æ–≥–æ—ç—Ç–∞–∂–Ω—ã—Ö –¥–æ–º–æ–≤, –Ω–∞—Å–µ–ª–µ–Ω–∏–µ –æ–∫–æ–ª–æ 4000 —á–µ–ª–æ–≤–µ–∫). –°—ä–µ–∑–¥ –¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –∑–∞ 60 –¥–Ω–µ–π.",
        decision: "–í —Ä–∞–±–æ—Ç–µ"
      },
      {
        id: 2,
        address: "—É–ª. –î–æ—Å—Ç–æ–µ–≤—Å–∫–æ–≥–æ, 15",
        district: "–°–æ—Ä–º–æ–≤—Å–∫–∏–π",
        link: "https://www.avito.ru/nizhniy_novgorod/kommercheskaya_nedvizhimost/svobodnogo_naznacheniya_40_2163527271",
        competitors: [
          { address: "—É–ª. –î–æ—Å—Ç–æ–µ–≤—Å–∫–æ–≥–æ, 20", name: "–ê–ø—Ç–µ—á–µ—Å—Ç–≤–æ", distance: "0,4 –∫–º", traffic: "950" }
        ],
        area: "70,0",
        rent: "80 000",
        anchor: { name: "–ü—è—Ç—ë—Ä–æ—á–∫–∞", traffic: "3500" },
        notes: "–ñ–ö '–£–¥–∞—á–Ω—ã–π-2' (3 –º–Ω–æ–≥–æ—ç—Ç–∞–∂–Ω—ã—Ö –¥–æ–º–∞)",
        decision: "–í —Ä–∞–±–æ—Ç–µ"
      },
      {
        id: 3,
        address: "—É–ª. –ü—É—Ç–µ–π—Å–∫–∞—è 30",
        district: "–ö–∞–Ω–∞–≤–∏–Ω—Å–∫–∏–π",
        link: "https://www.avito.ru/nizhniy_novgorod/kommercheskaya_nedvizhimost/obekt_1617017_7329288868",
        competitors: [],
        area: "65,0",
        rent: "50 000",
        anchor: null,
        notes: "–ü—Ä–∏ –ü—è—Ç—ë—Ä–æ—á–∫–µ. –í —Ä–∞–¥–∏—É—Å–µ 900 –º —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —á–∞—Å—Ç–Ω–∞—è –∞–ø—Ç–µ–∫–∞",
        decision: "–í —Ä–∞–±–æ—Ç–µ"
      }
    ];

    function savePlaces() {
      saveToFirebase();
    }

    function getDecisionBadge(decision) {
      switch(decision) {
        case '–ü–æ–¥—Ö–æ–¥–∏—Ç':
          return '<span class="badge badge-success">‚úì –ü–æ–¥—Ö–æ–¥–∏—Ç</span>';
        case '–í —Ä–∞–±–æ—Ç–µ':
          return '<span class="badge badge-warning">‚ü≥ –í —Ä–∞–±–æ—Ç–µ</span>';
        case '–ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç':
          return '<span class="badge badge-danger">‚úó –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç</span>';
        default:
          return '<span class="badge badge-info">–ë–µ–∑ —Ä–µ—à–µ–Ω–∏—è</span>';
      }
    }

    function renderCompetitors(competitorsList) {
      if (!competitorsList || competitorsList.length === 0) {
        return '<div class="card-field-value">-</div>';
      }
      return competitorsList.map(c => 
        `<div class="competitor-item">
          ${c.address ? `<div><small>${c.address}</small></div>` : ''}
          <strong>${c.name}</strong> ${c.distance || ''}<br>
          <small>–ü—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å: ${c.traffic || '-'} —á–µ–∫–æ–≤</small>
        </div>`
      ).join('');
    }

    function renderPlaces(filter = {}) {
        // PATCH: Read from DOM if filter is empty or partial
        if (!filter.decision && document.getElementById('filterDecision')) {
            filter.decision = document.getElementById('filterDecision').value;
        }
        if (!filter.district && document.getElementById('filterDistrict')) {
            filter.district = document.getElementById('filterDistrict').value;
        }
    
      const container = document.getElementById('cardsContainer');
      let filtered = places;

      if (filter.address) {
        const addr = filter.address.toLowerCase();
        filtered = filtered.filter(p => p.address.toLowerCase().includes(addr));
      }

      if (filter.district && filter.district !== '') {
        filtered = filtered.filter(p => p.district === filter.district);
      }

      if (filter.decision && filter.decision !== '') {
        filtered = filtered.filter(p => p.decision === filter.decision);
      }

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-state-icon">üì≠</div>
            <p>–ü–æ–º–µ—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
            <button class="btn btn-primary" onclick="openAddModal()">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ</button>
          </div>
        `;
        return;
      }

      container.innerHTML = filtered.map(place => `
        <div class="card">
          <div class="card-header" onclick="editPlace(${place.id})">
            <h3>${place.address}</h3>
            <p>${place.district} —Ä–∞–π–æ–Ω</p>
          </div>
          <div class="card-body">
            <div style="margin-bottom: 12px;">
              ${getDecisionBadge(place.decision)}
              <span class="badge badge-info">${place.area} –º¬≤</span>
              <span class="badge badge-info">${place.rent} ‚ÇΩ</span>
            </div>

            <div class="card-field">
              <div class="card-field-label">–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã</div>
              ${renderCompetitors(place.competitors)}
            </div>

            ${place.anchor ? `
              <div class="card-field">
                <div class="card-field-label">–Ø–∫–æ—Ä—å</div>
                <div class="anchor-item">
                  <strong>${place.anchor.name}</strong><br>
                  ${place.anchor.traffic ? `<small>–ü—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å: ${place.anchor.traffic} —á–µ–∫–æ–≤</small>` : ''}
                </div>
              </div>
            ` : ''}

            ${place.link ? `
              <div class="card-field">
                <div class="card-field-label">–°—Å—ã–ª–∫–∞</div>
                <div class="card-field-value">
                  <a href="${place.link}" target="_blank" rel="noopener" class="link">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</a>
                </div>
              </div>
            ` : ''}

            ${(place.landlordContact || place.landlordEmail || place.landlordPhone) ? `
              <div class="card-field">
                <div class="card-field-label">–ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å</div>
                <div class="card-field-value">
                  ${place.landlordContact ? `<div><strong>–ö–æ–Ω—Ç–∞–∫—Ç:</strong> ${place.landlordContact}</div>` : ''}
                  ${place.landlordEmail ? `<div><strong>Email:</strong> <a href="mailto:${place.landlordEmail}">${place.landlordEmail}</a></div>` : ''}
                  ${place.landlordPhone ? `<div><strong>–¢–µ–ª:</strong> <a href="tel:${place.landlordPhone}">${place.landlordPhone}</a></div>` : ''}
                </div>
              </div>
            ` : ''}

            ${place.notes ? `
              <div class="card-field">
                <div class="card-field-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</div>
                <div class="card-field-value">${place.notes}</div>
              </div>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    function renderCompetitorsForm() {
      const list = document.getElementById('competitorsList');
      list.innerHTML = competitors.map((comp, idx) => `
        <div class="competitor-row">
          <input type="text" placeholder="–ê–¥—Ä–µ—Å –∞–ø—Ç–µ–∫–∏" value="${comp.address || ''}" 
            onchange="competitors[${idx}].address = this.value">
          <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${comp.name}" 
            onchange="competitors[${idx}].name = this.value">
          <input type="text" placeholder="–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ" value="${comp.distance}" 
            onchange="competitors[${idx}].distance = this.value">
          <input type="text" placeholder="–ü—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å (—á–µ–∫–∏)" value="${comp.traffic}" 
            onchange="competitors[${idx}].traffic = this.value">
          <div class="competitor-actions">
            <button class="btn btn-remove" onclick="removeCompetitor(${idx})">‚úï</button>
          </div>
        </div>
      `).join('');
    }

    function addCompetitorField() {
      competitors.push({ address: '', name: '', distance: '', traffic: '' });
      renderCompetitorsForm();
    }

    function removeCompetitor(idx) {
      competitors.splice(idx, 1);
      renderCompetitorsForm();
    }

    function updateAnchorFields() {
      const isYes = document.querySelector('input[name="anchorType"]:checked').value === 'yes';
      document.getElementById('anchorFieldsContainer').style.display = isYes ? 'block' : 'none';
    }

    function openAddModal() {
      editingId = null;
      competitors = [];
      document.getElementById('deleteBtn').style.display = 'none';
      document.getElementById('addModal').querySelector('.modal-header').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–º–µ—â–µ–Ω–∏–µ';
      document.getElementById('formAddress').value = '';
      document.getElementById('formDistrict').value = '';
      document.getElementById('formLink').value = '';
      document.getElementById('formArea').value = '';
      document.getElementById('formRent').value = '';
      document.getElementById('formNotes').value = '';
      document.getElementById('formDecision').value = '–í —Ä–∞–±–æ—Ç–µ';
      document.getElementById('formLandlordContact').value = '';
      document.getElementById('formLandlordEmail').value = '';
      document.getElementById('formLandlordPhone').value = '';
      document.querySelector('input[name="anchorType"][value="no"]').checked = true;
      document.getElementById('formAnchorName').value = '';
      document.getElementById('formAnchorTraffic').value = '';
      updateAnchorFields();
      renderCompetitorsForm();
      document.getElementById('addModal').classList.add('active');
    }

    function editPlace(id) {
      const place = places.find(p => p.id === id);
      if (!place) return;

      editingId = id;
      competitors = JSON.parse(JSON.stringify(place.competitors || []));
      document.getElementById('deleteBtn').style.display = 'block';
      document.getElementById('addModal').querySelector('.modal-header').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–º–µ—â–µ–Ω–∏–µ';
      document.getElementById('formAddress').value = place.address;
      document.getElementById('formDistrict').value = place.district;
      document.getElementById('formLink').value = place.link;
      document.getElementById('formArea').value = place.area;
      document.getElementById('formRent').value = place.rent;
      document.getElementById('formNotes').value = place.notes;
      document.getElementById('formDecision').value = place.decision;
      document.getElementById('formLandlordContact').value = place.landlordContact || '';
      document.getElementById('formLandlordEmail').value = place.landlordEmail || '';
      document.getElementById('formLandlordPhone').value = place.landlordPhone || '';
      
      if (place.anchor) {
        document.querySelector('input[name="anchorType"][value="yes"]').checked = true;
        document.getElementById('formAnchorName').value = place.anchor.name;
        document.getElementById('formAnchorTraffic').value = place.anchor.traffic || '';
      } else {
        document.querySelector('input[name="anchorType"][value="no"]').checked = true;
      }
      
      updateAnchorFields();
      renderCompetitorsForm();
      document.getElementById('addModal').classList.add('active');
    }

    function closeAddModal() {
      document.getElementById('addModal').classList.remove('active');
      editingId = null;
      competitors = [];
    }

    function savePlace() {
      const address = document.getElementById('formAddress').value.trim();
      const district = document.getElementById('formDistrict').value;

      if (!address || !district) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –∞–¥—Ä–µ—Å –∏ —Ä–∞–π–æ–Ω');
        return;
      }

      const hasAnchor = document.querySelector('input[name="anchorType"]:checked').value === 'yes';
      let anchor = null;
      if (hasAnchor) {
        const anchorName = document.getElementById('formAnchorName').value.trim();
        const anchorTraffic = document.getElementById('formAnchorTraffic').value.trim();
        if (anchorName) {
          anchor = { name: anchorName, traffic: anchorTraffic || '' };
        }
      }

      const place = {
        address,
        district,
        link: document.getElementById('formLink').value.trim(),
        competitors: competitors.filter(c => c.name.trim() !== ''),
        area: document.getElementById('formArea').value.trim(),
        rent: document.getElementById('formRent').value.trim(),
        anchor: anchor,
        notes: document.getElementById('formNotes').value.trim(),
        decision: document.getElementById('formDecision').value,
        landlordContact: document.getElementById('formLandlordContact').value.trim(),
        landlordEmail: document.getElementById('formLandlordEmail').value.trim(),
        landlordPhone: document.getElementById('formLandlordPhone').value.trim()
      };

      if (editingId) {
        const index = places.findIndex(p => p.id === editingId);
        if (index !== -1) {
          places[index] = { ...places[index], ...place };
        }
      } else {
        place.id = Math.max(...places.map(p => p.id), 0) + 1;
        places.push(place);
      }

      savePlaces();
      renderPlaces(getFilter());
      closeAddModal();
    }

    function deletePlace() {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø–æ–º–µ—â–µ–Ω–∏–µ?')) {
        places = places.filter(p => p.id !== editingId);
        savePlaces();
        renderPlaces(getFilter());
        closeAddModal();
      }
    }

    function getFilter() {
      return {
        address: document.getElementById('searchAddress').value,
        district: document.getElementById('filterDistrict').value,
        decision: document.getElementById('filterDecision').value
      };
    }

    function applyFilters() {
      renderPlaces(getFilter());
    }

    function clearFilters() {
      document.getElementById('searchAddress').value = '';
      document.getElementById('filterDistrict').value = '';
      document.getElementById('filterDecision').value = '';
      renderPlaces(getFilter());
    }

    // Initial render
    renderPlaces();
  </script>
</body>
</html>