<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –∞–ø—Ç–µ–∫–∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* –°–ê–ô–ë–ï–†–ë–ê–† */
        #sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 240px;
            height: 100vh;
            background: #f3f4f6;
            box-shadow: 2px 0 10px rgba(0,0,0,0.08);
            padding: 16px;
            display: flex;
            flex-direction: column;
            z-index: 999;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
        }
        
        #sidebar > div:first-child {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        #sidebar > div:first-child > div:first-child {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        #sidebar > div:first-child h2 {
            font-size: 14px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 4px;
        }
        
        #sidebar > div:first-child p {
            font-size: 11px;
            color: #718096;
            line-height: 1.4;
        }
        
        #sidebar h3 { font-size: 13px; font-weight: 700; color: #10b981; text-transform: uppercase; letter-spacing: 1px; margin-top: 50px; margin-bottom: 20px; }
        
        #projectList {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
        }
        
        .project-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            font-size: 13px;
            color: #4a5568;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .project-item:hover {
            background: #f0fdf4;
        }
        
        .project-item.active {
            border-color: #10b981;
            background: #ecfdf5;
            color: #047857;
            font-weight: 600;
        }
        
        .project-delete {
            color: #ef4444;
            cursor: pointer;
            font-weight: bold;
            padding: 0 4px;
        }
        
        .project-delete:hover {
            color: #dc2626;
        }
        
        #newProjectBtn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            width: 100%;
            transition: all 0.2s ease;
            margin-bottom: 8px;
        }
        
        #newProjectBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        #hideCompletedBtn {
            background: #cbd5e0;
            color: #4a5568;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: background 0.2s ease;
            white-space: nowrap;
        }

        #hideCompletedBtn:hover {
            background: #a0aec0;
        }

        #editTemplateBtn {
            background: #cbd5e0;
            color: #4a5568;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            width: 100%;
            transition: background 0.2s ease;
        }
        
        #editTemplateBtn:hover {
            background: #a0aec0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #d4f1e8 0%, #c8e6d7 100%);
            min-height: 100vh;
            padding: 20px;
            padding-left: 280px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        #pharmacyNumberHeader {
            font-size: 40px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 30px;
            padding: 20px 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 30px;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f4f8;
        }

        .card-icon {
            font-size: 28px;
        }

        .card-header h2 {
            color: #2d3748;
            font-size: 18px;
            font-weight: 600;
        }

        .top-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .staff-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .staff-box {
            background: linear-gradient(135deg, #f0fdf4 0%, #f0f9ff 100%);
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer;
        }

        .staff-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.2);
            border-color: #059669;
        }

        .staff-box-field {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .staff-box-label {
            font-size: 10px;
            font-weight: 700;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .staff-box-value {
            font-size: 13px;
            font-weight: 500;
            color: #2d3748;
            word-break: break-word;
        }

        .tasks-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .tasks-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            width: 100%;
        }

        .task-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #f0fdf4 100%);
            border: 2px solid #10b981;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 15px;
            cursor: pointer;
            position: relative;
            padding-left: 50px;
        }

        .task-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2);
            border-color: #059669;
        }

        .task-box.status-completed-box {
            background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
            border-color: #86efac;
            opacity: 0.85;
        }

        .task-box.status-completed-box .task-box-title {
            text-decoration: line-through;
            color: #6b7280;
        }

        .task-box.hidden-task {
            display: none !important;
        }


        .task-row-pc.hidden-task {
            display: none !important;
        }
        .task-box-header-row {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: space-between;
        }

        .task-box-title-section {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .task-box-number {
            background: #10b981;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .task-box-title {
            font-size: 15px;
            font-weight: 700;
            color: #2d3748;
            word-break: break-word;
        }

        .task-box-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .task-box-label {
            font-size: 11px;
            font-weight: 600;
            color: #718096;
            text-transform: uppercase;
        }

        .task-box-value {
            font-size: 13px;
            font-weight: 500;
            color: #2d3748;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
        }

        .status-completed {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-inprogress {
            background: #bee3f8;
            color: #2c5282;
        }

        .status-postponed {
            background: #fed7d7;
            color: #742a2a;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-box {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .stat-box:nth-child(1) {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .stat-box:nth-child(1):hover {
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }

        .stat-box:nth-child(2) {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .stat-box:nth-child(2):hover {
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .stat-box:nth-child(3) {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .stat-box:nth-child(3):hover {
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
        }

        .stat-box:nth-child(4) {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .stat-box:nth-child(4):hover {
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.9;
        }

        .progress-container {
            margin-top: 20px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: #4a5568;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .action-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        input[type="text"],
        input[type="date"],
        input[type="tel"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-family: inherit;
            margin-bottom: 10px;
            font-size: 14px;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="tel"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .info-field {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 15px;
            align-items: start;
        }

        .info-field label {
            font-weight: 600;
            color: #2d3748;
            padding-top: 10px;
        }

        .info-field input {
            margin-bottom: 0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã—à–µ templateModal */
        #staffModal {
            z-index: 1100 !important;
        }

        #planModal {
            z-index: 1100 !important;
        }

        #staffModal .modal-content {
            z-index: 1101 !important;
        }

        #planModal .modal-content {
            z-index: 1101 !important;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content-large {
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f4f8;
        }

        .modal-header h2 {
            color: #2d3748;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #a0aec0;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #2d3748;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            flex: 1;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            flex: 1;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-danger {
            background: #cbd5e0;
            color: #4a5568;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            flex: 1;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background: #a0aec0;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            flex: 1;
            transition: all 0.3s ease;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .card-header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f4f8;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .card-header-controls .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .template-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .template-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .template-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #8b5cf6;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .template-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateX(5px);
        }

        .template-item-info {
            flex: 1;
        }

        .template-item-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .template-item-details {
            font-size: 12px;
            color: #718096;
        }

        @media (max-width: 1024px) {
            .staff-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .tasks-grid {
                max-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .top-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .staff-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .tasks-container {
                display: block;
            }
            .tasks-grid {
                max-width: 100%;
            }
            .task-box {
                flex-direction: column;
            }
            .task-box-header-row {
                flex-wrap: wrap;
            }
            .info-field {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            .button-group {
                flex-direction: column;
            }
        }
    
        @media (max-width: 768px) {
            body {
                padding-left: 0;
                padding: 12px;
                padding-top: 60px;
            }

            #sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                width: 280px;
                height: 100vh;
                background: #f3f4f6;
                padding: 16px;
                display: flex;
                flex-direction: column;
                z-index: 1001;
                border-right: 1px solid #e5e7eb;
                overflow-y: auto;
                transition: left 0.3s ease;
                box-shadow: 2px 0 10px rgba(0,0,0,0.15);
            }

            #sidebar.mobile-open {
                left: 0;
            }

            .sidebar-toggle {
                position: fixed;
                top: 12px;
                left: 12px;
                width: 44px;
                height: 44px;
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                z-index: 1000;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .sidebar-toggle:hover {
                background: #f9f9f9;
            }
        }
    </style>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        window.allProjects = [];
        window.templateStaff = [];
        window.templateTasks = [];
        window.isFirebaseReady = false; 

        const firebaseConfig = {
          apiKey: "AIzaSyCXU_qtA65zudpgUsdNdbndOSpuGRbEJ2c",
          authDomain: "pharmacy-manager-d7802.firebaseapp.com",
          projectId: "pharmacy-manager-d7802",
          storageBucket: "pharmacy-manager-d7802.firebasestorage.app",
          messagingSenderId: "60028648458",
          appId: "1:60028648458:web:45e2a124ea3b7d7c46f3f3",
        };

        try {
            firebase.initializeApp(firebaseConfig);
            var db = firebase.firestore();
        } catch(e) { console.error("Firebase Init Fail", e); }

        const DOC_REF = db.collection("pharmacy_app").doc("shared_data");

        function setStatus(msg, color) {
            const el = document.getElementById('syncStatus');
            if(!el) return;
            let icon = 'üîÑ';
            if (msg.includes('–∑–∞–≥—Ä—É–∂–µ–Ω—ã') || msg.includes('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ')) icon = '‚úÖ';
            else if (msg.includes('–û—à–∏–±–∫–∞')) icon = '‚ùå';
            else if (msg.includes('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ')) icon = '‚è≥';
            el.innerHTML = `<span style="cursor: help; font-size: 14px;" title="${msg}">${icon}</span>`;
        }

        window.saveToFirebase = function() {
            if (!window.isFirebaseReady) return;
            setStatus("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...", "orange");
            const data = { allProjects: window.allProjects || [], templateStaff: window.templateStaff || [], templateTasks: window.templateTasks || [] };
            DOC_REF.set(data, { merge: true })
            .then(() => setStatus("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ", "green"))
            .catch((err) => { setStatus("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "red"); console.error(err); });
        };

        window.initFirebaseSync = function() {
            setStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...", "blue");
            DOC_REF.onSnapshot((doc) => {
                window.isFirebaseReady = true;
                if (doc.exists) {
                    const data = doc.data();
                    window.allProjects = data.allProjects || [];
                    window.templateStaff = data.templateStaff || [];
                    window.templateTasks = data.templateTasks || [];
                    setStatus("–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã", "green");
                } else {
                     setStatus("–ë–∞–∑–∞ –ø—É—Å—Ç–∞", "gray");
                }

                if (window.templateStaff.length === 0 && typeof DEFAULT_STAFF !== 'undefined') {
                    window.templateStaff = JSON.parse(JSON.stringify(DEFAULT_STAFF));
                    saveToFirebase();
                }
                if (window.templateTasks.length === 0 && typeof DEFAULT_TASKS !== 'undefined') {
                    window.templateTasks = JSON.parse(JSON.stringify(DEFAULT_TASKS));
                    saveToFirebase();
                }

                if (typeof renderProjectList === 'function') renderProjectList();
                if (typeof loadFromLocalStorage === 'function') loadFromLocalStorage();
            }, (err) => {
                setStatus("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î", "red");
                alert("–û—à–∏–±–∫–∞: " + err.message);
            });
        };
    </script>

</head>
<body>
    <!-- –°–ê–ô–ë–ï–†–ë–ê–† –ü–†–û–ï–ö–¢–û–í -->
    <button id="toggleBtn" class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
    <div id="sidebar"><div style="text-align: right; height: 10px;"><span id="syncStatus"></span></div>
        <div>
            <div>üè•</div>
            <h2 style="font-size: 18px; line-height: 1.2; margin-bottom: 5px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –∞–ø—Ç–µ–∫–∏</h2>
            <p style="font-size: 11px; color: #888; line-height: 1.3;">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–æ–≤–æ–π –∞–ø—Ç–µ–∫–∏</p>
        </div>
        <h3>–ü—Ä–æ–µ–∫—Ç—ã</h3>
        <div id="projectList"></div>
        <button id="newProjectBtn">+ –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
        <button id="editTemplateBtn">‚öôÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
    </div>

    <div class="container">
        <!-- –ù–û–ú–ï–† –ê–ü–¢–ï–ö–ò –í –ó–ê–ì–û–õ–û–í–ö–ï –°–¢–†–ê–ù–ò–¶–´ -->
        <div id="pharmacyNumberHeader">
            <span id="pharmacyNumberSpan">–ù–µ –≤—ã–±—Ä–∞–Ω–∞</span>
        </div>

        <!-- –ê–ù–ê–õ–ò–¢–ò–ö–ê –ò –û–ë–©–ò–ï –°–í–ï–î–ï–ù–ò–Ø –†–Ø–î–û–ú -->
        <div class="top-section">
            <!-- Analytics Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üìä</div>
                    <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box" onclick="scrollToTasks()">
                        <div class="stat-number" id="totalTasks">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                    </div>
                    <div class="stat-box" onclick="scrollToTasks()">
                        <div class="stat-number" id="completedTasks">0</div>
                        <div class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                    </div>
                    <div class="stat-box" onclick="scrollToTasks()">
                        <div class="stat-number" id="inProgressTasks">0</div>
                        <div class="stat-label">–í —Ä–∞–±–æ—Ç–µ</div>
                    </div>
                    <div class="stat-box" onclick="scrollToTasks()">
                        <div class="stat-number" id="postponedTasks">0</div>
                        <div class="stat-label">–û—Ç–ª–æ–∂–µ–Ω–æ</div>
                    </div>
                </div>

                <div class="progress-container">
                    <div class="progress-label">
                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- General Information Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üìã</div>
                    <h2 style="cursor: pointer; user-select: none;" onclick="openGeneralInfoModal()">–û–±—â–∏–µ —Å–≤–µ–¥–µ–Ω–∏—è</h2>
                </div>
                <div id="generalInfoContent">
                    <p style="color: #a0aec0; text-align: center; padding: 30px 0;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                </div>
                
            </div>
        </div>

        <!-- Responsible Staff Card -->
        <div class="card" id="staffCard">
            <div class="card-header" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="document.getElementById('staffGridContainer').style.display = document.getElementById('staffGridContainer').style.display === 'none' ? 'block' : 'none'; document.getElementById('staffBtn').style.display = document.getElementById('staffBtn').style.display === 'none' ? 'block' : 'none'; document.getElementById('collapseArrow').style.transform = document.getElementById('collapseArrow').style.transform === 'rotate(-90deg)' ? 'rotate(0deg)' : 'rotate(-90deg)';">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="card-icon">üë•</div>
                    <h2 style="margin: 0;">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2>
                </div>
                <div id="collapseArrow" style="font-size: 20px; color: #10b981; transition: transform 0.3s ease;">‚ñº</div>
            </div>
            <div id="staffGridContainer">
                <div class="staff-grid" id="staffGrid">
                    <div style="text-align: center; color: #a0aec0; padding: 30px; grid-column: 1 / -1;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <button class="action-btn" id="staffBtn" onclick="openStaffModal()" style="width: 100%; margin-top: 15px;">+ –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
            </div>
        </div>

        <!-- Opening Event Plan Card -->
        <div class="card" id="tasksCard">
            <div class="card-header-controls">
                <div class="header-title">
                    <div style="font-size: 20px;">‚úÖ</div>
                    <h2>–ü–ª–∞–Ω –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –æ—Ç–∫—Ä—ã—Ç–∏—è</h2>
                </div>
                <button id="hideCompletedBtn" onclick="toggleHideCompleted()">–°–∫—Ä—ã—Ç—å –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</button>
            </div>
            <div class="tasks-container">
                <div class="tasks-grid" id="tasksGrid">
                    <div style="text-align: center; color: #a0aec0; padding: 30px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
            <div style="text-align: center;">
                <button class="action-btn" onclick="openPlanModal()">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- General Info Modal -->
    <div id="generalInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–ø—Ç–µ–∫–µ</h2>
                <button class="close-btn" onclick="closeGeneralInfoModal()">&times;</button>
            </div>
            <div>
                <div class="info-field">
                    <label>–ù–æ–º–µ—Ä –∞–ø—Ç–µ–∫–∏:</label>
                    <input type="text" id="pharmacyNumber" placeholder="">
                </div>
                <div class="info-field">
                    <label>–Æ—Ä.–ª–∏—Ü–æ:</label>
                    <input type="text" id="legalEntity" placeholder="">
                </div>
                <div class="info-field">
                    <label>–ê–¥—Ä–µ—Å:</label>
                    <input type="text" id="pharmacyAddress" placeholder="">
                </div>
                <div class="info-field">
                    <label>–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:</label>
                    <input type="text" id="workingHours" placeholder="">
                </div>
                <div class="info-field">
                    <label>–ê—Ä–µ–Ω–¥–∞, –∫–æ–Ω—Ç.–¥–∞–Ω–Ω—ã–µ:</label>
                    <input type="text" id="rentalInfo" placeholder="">
                </div>
                <div class="info-field">
                    <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã:</label>
                    <input type="text" id="documentsLink" placeholder="https://drive.google.com/...">
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="saveGeneralInfo()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn-warning" onclick="clearGeneralInfo()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Modal -->
    <div id="staffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="staffModalTitle">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
                <button class="close-btn" onclick="closeStaffModal()">&times;</button>
            </div>
            <div>
                <input type="text" id="staffPosition" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å">
                <input type="text" id="staffName" placeholder="–§–ò–û">
                <input type="text" id="staffEmail" placeholder="Email">
                <input type="tel" id="staffPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
                <div class="button-group" id="staffButtonGroup">
                    <button class="btn-primary" onclick="addStaff()">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button class="btn-secondary" onclick="closeStaffModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Plan Modal -->
    <div id="planModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="planModalTitle">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –ø–ª–∞–Ω–∞</h2>
                <button class="close-btn" onclick="closePlanModal()">&times;</button>
            </div>
            <div>
                <input type="text" id="taskName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
                <select id="taskResponsible">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</option>
                </select>
                <select id="taskStatus">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                    <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                    <option value="inprogress">–í —Ä–∞–±–æ—Ç–µ</option>
                    <option value="postponed">–û—Ç–ª–æ–∂–µ–Ω–æ</option>
                </select>
                <input type="text" id="taskComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
                                <input type="text" id="taskDocumentUrl" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                <div class="button-group" id="planButtonGroup">
                    <button class="btn-primary" id="planSaveBtn" onclick="savePlanTask()">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button class="btn-secondary" onclick="closePlanModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Editor Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω</h2>
                <button class="close-btn" onclick="closeTemplateModal()">&times;</button>
            </div>
            <div class="template-section">
                <h3 style="margin-bottom: 15px; color: #2d3748;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (–±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∫–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç)</h3>
                <div class="template-list" id="templateStaffList">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                <button class="action-btn" onclick="addTemplateStaff()" style="width: 100%; margin-top: 15px;">+ –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
            </div>

            <div class="template-section">
                <h3 style="margin-bottom: 15px; color: #2d3748;">–ó–∞–¥–∞—á–∏ (–±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∫–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç)</h3>
                <div class="template-list" id="templateTasksList">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                <button class="action-btn" onclick="addTemplateTask()" style="width: 100%; margin-top: 15px;">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="saveTemplate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
                <button class="btn-secondary" onclick="closeTemplateModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        // ===== –ú–£–õ–¨–¢–ò–ü–†–û–ï–ö–¢–ù–ê–Ø –°–ò–°–¢–ï–ú–ê =====
// let allProjects = JSON.parse(localStorage.getItem('allProjects') || '[]');
        let selectedProjectId = localStorage.getItem('selectedProjectId');

        // Data storage
        let generalInfo = {};
        let staffList = [];
        let planList = [];
        let editingStaffId = null;
        let editingTaskId = null;
        let hideCompleted = false;

        // –®–ê–ë–õ–û–ù - –∑–∞–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
// let templateStaff = JSON.parse(localStorage.getItem('templateStaff') || '[]');
// let templateTasks = JSON.parse(localStorage.getItem('templateTasks') || '[]');

        const DEFAULT_STAFF = [
            { id: 1, position: '–î–∏—Ä–µ–∫—Ç–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞', name: '–ë–æ—á–∞—Ä–æ–≤–∞ –ê.–í.', email: 'a.bocharova@aloea.ru', phone: '+7 (904) 252-31-00' },
            { id: 2, position: '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π –ê–û', name: '–ö–æ—à–µ–ª–µ–≤–∞ –ï.–ê.', email: 'e.kosheleva@aloea.ru', phone: '+7 (904) 653-29-38' },
            { id: 3, position: '–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä', name: '–ö–ª—é–∫–∏–Ω –°.–ù.', email: 's.klyukin@aloea.ru', phone: '+7 (904) 041-00-17' },
            { id: 4, position: '–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—É', name: '–í–æ—Å—Ç–æ–∫–æ–≤–∞ –Æ.–í.', email: 'y.vostokova@aloea.ru', phone: '+7 (919) 025-15-98' },
            { id: 5, position: '–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', name: '–ü–∞–≤–ª–æ–≤ –ê.–§.', email: 'a.pavlov@aloea.ru', phone: '+7 (920) 916-97-09' },
            { id: 6, position: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –ê–•–û', name: '–ì–∞—Ä–≤–∏–Ω –†.', email: 'r.gavrin@aloea.ru', phone: '+7 (904) 857-73-73' },
            { id: 7, position: '–°—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä', name: '–ì–æ—Ä–æ—à–∏–ª–æ–≤–∞ –ù.–ù.', email: 'n.goroshilova@aloea.ru', phone: '+7 (953) 343-59-36' },
            { id: 8, position: '–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥', name: '–ú–∞—à–µ—Ä–∏—á–µ–≤–∞ –ú.–ê.', email: 'm.evstrat@aloea.ru', phone: '+7 (999) 799-36-06' }
        ];

        const DEFAULT_TASKS = [
            { id: 1, name: '–°–Ω—è—Ç—å –∑–∞–º–µ—Ä—ã –ø–æ–º–µ—â–µ–Ω–∏—è', responsible: '–ö–ª—é–∫–∏–Ω –°.–ù.', status: 'inprogress', comment: '' },
            { id: 2, name: '–†–µ–º–æ–Ω—Ç', responsible: '–ì–∞—Ä–≤–∏–Ω –†.', status: 'inprogress', comment: '' },
            { id: 3, name: '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–µ–±–µ–ª–∏', responsible: '–ì–æ—Ä–æ—à–∏–ª–æ–≤–∞ –ù.–ù.', status: 'inprogress', comment: '' },
            { id: 4, name: '–§–∞—Ä–º–∞—Ü–µ–≤—Ç–∏—á–µ—Å–∫–∏–µ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏', responsible: '–ë–æ—á–∞—Ä–æ–≤–∞ –ê.–í.', status: 'inprogress', comment: '' },
            { id: 5, name: '–î–∞–Ω–Ω—ã–µ –ø–æ —Ä–µ–∂–∏–º—É —Ä–∞–±–æ—Ç—ã', responsible: '–ö–ª—é–∫–∏–Ω –°.–ù.', status: 'inprogress', comment: '' },
            { id: 6, name: '–ó–∞–∫–∞–∑–∞—Ç—å –Ω–∞–∫–ª–µ–π–∫–∏ –≤ –∞–ø—Ç–µ–∫—É', responsible: '–ö–ª—é–∫–∏–Ω –°.–ù.', status: 'inprogress', comment: '' },
            { id: 7, name: '–≠–∫—Å–ø–µ—Ä—Ç–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –≤ –¶–≠–ò–ì', responsible: '–ö–ª—é–∫–∏–Ω –°.–ù.', status: 'inprogress', comment: '' },
            { id: 8, name: '–°–≠–ó', responsible: '–ë–æ—á–∞—Ä–æ–≤–∞ –ê.–í.', status: 'inprogress', comment: '' },
            { id: 9, name: '–£–±–æ—Ä–∫–∞ –ø–æ–º–µ—â–µ–Ω–∏—è', responsible: '–ö–ª—é–∫–∏–Ω –°.–ù.', status: 'inprogress', comment: '' },
            { id: 10, name: '–ü–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤', responsible: '–í–æ—Å—Ç–æ–∫–æ–≤–∞ –Æ.–í.', status: 'inprogress', comment: '' },
            { id: 11, name: '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ò–¢ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è', responsible: '–ü–∞–≤–ª–æ–≤ –ê.–§.', status: 'inprogress', comment: '' },
            { id: 12, name: '–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞', responsible: '–ü–∞–≤–ª–æ–≤ –ê.–§.', status: 'inprogress', comment: '' },
            { id: 13, name: '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ –°–±–µ—Ä–±–∞–Ω–∫', responsible: '–ë–æ—á–∞—Ä–æ–≤–∞ –ê.–í.', status: 'inprogress', comment: '' },
            { id: 14, name: '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∞–ø—Ç–µ–∫–∏ –∫ –æ—Ö—Ä–∞–Ω–µ', responsible: '–ë–æ—á–∞—Ä–æ–≤–∞ –ê.–í.', status: 'inprogress', comment: '' },
            { id: 15, name: '–ó–∞–∫–∞–∑ –≤ –ö–û–ú–£–°', responsible: '–ö–æ—à–µ–ª–µ–≤–∞ –ï.–ê.', status: 'inprogress', comment: '' },
            { id: 16, name: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è', responsible: '–ö–ª—é–∫–∏–Ω –°.–ù.', status: 'inprogress', comment: '' },
            { id: 17, name: '–†–µ–∫–ª–∞–º–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏–∑ –æ—Ñ–∏—Å–∞', responsible: '–ö–æ—à–µ–ª–µ–≤–∞ –ï.–ê.', status: 'inprogress', comment: '' },
            { id: 18, name: '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏—é', responsible: '–ö–ª—é–∫–∏–Ω –°.–ù.', status: 'inprogress', comment: '' },
            { id: 19, name: '–í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∞–ø—Ç–µ–∫–∏, —Ä–µ–∫–ª–∞–º–∞', responsible: '–ú–∞—à–µ—Ä–∏—á–µ–≤–∞ –ú.–ê.', status: 'inprogress', comment: '' },
            { id: 20, name: '–í–Ω–µ—à–Ω–µ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∞–ø—Ç–µ–∫–∏, —Ä–µ–∫–ª–∞–º–∞', responsible: '–ú–∞—à–µ—Ä–∏—á–µ–≤–∞ –ú.–ê.', status: 'inprogress', comment: '' },
            { id: 21, name: '–ó–∞–Ω–µ—Å–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –§–†–ú–û', responsible: '–ë–æ—á–∞—Ä–æ–≤–∞ –ê.–í.', status: 'inprogress', comment: '' },
            { id: 22, name: '–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–∞ —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç–∏—á–µ—Å–∫—É—é –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å', responsible: '–ë–æ—á–∞—Ä–æ–≤–∞ –ê.–í.', status: 'inprogress', comment: '' },
            { id: 23, name: '–°–¥–µ–ª–∞—Ç—å –ø—Ä–æ–º–æ –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏–µ', responsible: '–ö–ª—é–∫–∏–Ω –°.–ù.', status: 'inprogress', comment: '' },
            { id: 24, name: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º', responsible: '–ö–ª—é–∫–∏–Ω –°.–ù.', status: 'inprogress', comment: '' }
        ];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–∞ –µ—Å–ª–∏ –ø—É—Å—Ç
        if (templateStaff.length === 0) {
            templateStaff = JSON.parse(JSON.stringify(DEFAULT_STAFF));
            saveToFirebase();
        }
        if (templateTasks.length === 0) {
            templateTasks = JSON.parse(JSON.stringify(DEFAULT_TASKS));
            saveToFirebase();
        }

        function scrollToTasks() {
            document.getElementById('tasksCard').scrollIntoView({ behavior: 'smooth' });
        }

        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –®–ê–ë–õ–û–ù–û–ú =====
        function openTemplateModal() {
            document.getElementById('sidebar').classList.remove('mobile-open');
            renderTemplateStaffList();
            renderTemplateTasksList();
            document.getElementById('templateModal').style.display = 'block';
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').style.display = 'none';
        }

        function renderTemplateStaffList() {
            const list = document.getElementById('templateStaffList');
            list.innerHTML = templateStaff.map((staff, idx) => `
                <div class="template-item">
                    <div class="template-item-info">
                        <div class="template-item-name">${staff.position}</div>
                        <div class="template-item-details">${staff.name} ‚Ä¢ ${staff.phone}</div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn-warning" style="width: auto; padding: 6px 8px; font-size: 12px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="editTemplateStaff(${idx})">‚úé</button>
                        <button class="btn-danger" style="width: auto; padding: 6px 12px; font-size: 12px;" onclick="deleteTemplateStaff(${idx})">‚úï</button>
                    </div>
                </div>
            `).join('');
        }

        function renderTemplateTasksList() {
            const list = document.getElementById('templateTasksList');
            list.innerHTML = templateTasks.map((task, idx) => `
                <div class="template-item">
                    <div class="template-item-info">
                        <div class="template-item-name">${task.name}</div>
                        <div class="template-item-details">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: ${task.responsible}</div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn-warning" style="width: auto; padding: 6px 8px; font-size: 12px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="editTemplateTask(${idx})">‚úé</button>
                        <button class="btn-danger" style="width: auto; padding: 6px 12px; font-size: 12px;" onclick="deleteTemplateTask(${idx})">‚úï</button>
                    </div>
                </div>
            `).join('');
        }

        function addTemplateStaff() {
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
            document.getElementById('staffModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (—à–∞–±–ª–æ–Ω)';
            document.getElementById('staffPosition').value = '';
            document.getElementById('staffName').value = '';
            document.getElementById('staffEmail').value = '';
            document.getElementById('staffPhone').value = '';

            // –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ —ç—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            editingTemplateStaffIndex = 'new';

            document.getElementById('staffButtonGroup').innerHTML = `
                <button class="btn-primary" onclick="saveNewTemplateStaff()">–î–æ–±–∞–≤–∏—Ç—å</button>
                <button class="btn-cancel" onclick="closeStaffModal()">–û—Ç–º–µ–Ω–∞</button>
            `;

            document.getElementById('staffModal').style.display = 'block';
        }

        function deleteTemplateStaff(idx) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ —à–∞–±–ª–æ–Ω–∞?')) {
                templateStaff.splice(idx, 1);
                saveToFirebase();
                renderTemplateStaffList();
            }
        }

        function addTemplateTask() {
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
            document.getElementById('planModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É (—à–∞–±–ª–æ–Ω)';
            document.getElementById('taskName').value = '';
            document.getElementById('taskResponsible').value = '';
            document.getElementById('taskStatus').value = '–í —Ä–∞–±–æ—Ç–µ';
            document.getElementById('taskComment').value = '';
            document.getElementById('taskDocumentUrl').value = '';

            // –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ —ç—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            editingTemplateTaskIndex = 'new';

            document.getElementById('planButtonGroup').innerHTML = `
                <button class="btn-primary" onclick="saveNewTemplateTask()">–î–æ–±–∞–≤–∏—Ç—å</button>
                <button class="btn-cancel" onclick="closePlanModal()">–û—Ç–º–µ–Ω–∞</button>
            `;

            document.getElementById('planModal').style.display = 'block';
        }

        function deleteTemplateTask(idx) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É –∏–∑ —à–∞–±–ª–æ–Ω–∞?')) {
                templateTasks.splice(idx, 1);
                saveToFirebase();
                renderTemplateTasksList();
            }
        }

        
        // ===== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –í –®–ê–ë–õ–û–ù–ï =====
        let editingTemplateStaffIndex = null;
        let editingTemplateTaskIndex = null;

        function editTemplateStaff(idx) {
            editingTemplateStaffIndex = idx;
            const staff = templateStaff[idx];

            document.getElementById('staffModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (—à–∞–±–ª–æ–Ω)';
            document.getElementById('staffPosition').value = staff.position;
            document.getElementById('staffName').value = staff.name;
            document.getElementById('staffEmail').value = staff.email || '';
            document.getElementById('staffPhone').value = staff.phone;

            document.getElementById('staffButtonGroup').innerHTML = `
                <button class="btn-primary" onclick="saveEditedTemplateStaff()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn-danger" onclick="deleteTemplateStaff(\${idx})">–£–¥–∞–ª–∏—Ç—å</button>
            `;

            document.getElementById('staffModal').style.display = 'block';
        }

        function editTemplateTask(idx) {
            editingTemplateTaskIndex = idx;
            const task = templateTasks[idx];

            document.getElementById('planModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É (—à–∞–±–ª–æ–Ω)';
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskResponsible').value = task.responsible;
            document.getElementById('taskStatus').value = task.status || '–í —Ä–∞–±–æ—Ç–µ';
            document.getElementById('taskComment').value = task.comment || '';
            document.getElementById('taskDocumentUrl').value = task.documentUrl || '';

            document.getElementById('planButtonGroup').innerHTML = `
                <button class="btn-primary" onclick="saveEditedTemplateTask()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn-danger" onclick="deleteTemplateTask(\${idx})">–£–¥–∞–ª–∏—Ç—å</button>
            `;

            document.getElementById('planModal').style.display = 'block';
        }

        function saveEditedTemplateStaff() {
            if (editingTemplateStaffIndex === null) return;

            const position = document.getElementById('staffPosition').value.trim();
            const name = document.getElementById('staffName').value.trim();
            const email = document.getElementById('staffEmail').value.trim();
            const phone = document.getElementById('staffPhone').value.trim();

            if (!position || !name || !email || !phone) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            templateStaff[editingTemplateStaffIndex] = {
                id: templateStaff[editingTemplateStaffIndex].id,
                position,
                name,
                email,
                phone
            };

            saveToFirebase();
            renderTemplateStaffList();
            document.getElementById('staffModal').style.display = 'none';
            editingTemplateStaffIndex = null;
        }

        function saveEditedTemplateTask() {
            if (editingTemplateTaskIndex === null) return;

            const name = document.getElementById('taskName').value.trim();
            const responsible = document.getElementById('taskResponsible').value.trim();
            const status = document.getElementById('taskStatus').value;
            const comment = document.getElementById('taskComment').value.trim();
            const documentUrl = document.getElementById('taskDocumentUrl').value.trim();

            if (!name || !responsible) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            templateTasks[editingTemplateTaskIndex] = {
                name,
                responsible,
                status: status || '–í —Ä–∞–±–æ—Ç–µ',
                comment,
                documentUrl
            };

            saveToFirebase();
            renderTemplateTasksList();
            document.getElementById('planModal').style.display = 'none';
            editingTemplateTaskIndex = null;
        }

        function saveNewTemplateStaff() {
            const position = document.getElementById('staffPosition').value.trim();
            const name = document.getElementById('staffName').value.trim();
            const email = document.getElementById('staffEmail').value.trim();
            const phone = document.getElementById('staffPhone').value.trim();

            if (!position || !name || !email || !phone) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            templateStaff.push({
                id: Date.now(),
                position,
                name,
                email,
                phone
            });

            saveToFirebase();
            renderTemplateStaffList();
            document.getElementById('staffModal').style.display = 'none';
            editingTemplateStaffIndex = null;
        }

        function saveNewTemplateTask() {
            const name = document.getElementById('taskName').value.trim();
            const responsible = document.getElementById('taskResponsible').value.trim();
            const status = document.getElementById('taskStatus').value;
            const comment = document.getElementById('taskComment').value.trim();
            const documentUrl = document.getElementById('taskDocumentUrl').value.trim();

            if (!name || !responsible) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            templateTasks.push({
                id: Date.now(),
                name,
                responsible,
                status: status || '–í —Ä–∞–±–æ—Ç–µ',
                comment,
                documentUrl
            });

            saveToFirebase();
            renderTemplateTasksList();
            document.getElementById('planModal').style.display = 'none';
            editingTemplateTaskIndex = null;
        }
        // ===== –ö–û–ù–ï–¶ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –í –®–ê–ë–õ–û–ù–ï =====

        function saveTemplate() {
            saveToFirebase();
            saveToFirebase();
            closeTemplateModal();
            alert('–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω! –ù–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –Ω–∞ –µ–≥–æ –æ—Å–Ω–æ–≤–µ.');
        }

        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ï–ö–¢–ê–ú–ò =====
        function renderProjectList() {
            const list = document.getElementById('projectList');
            list.innerHTML = '';
            
            if (allProjects.length === 0) {
                list.innerHTML = '<p style="color:#a0aec0;font-size:12px;text-align:center;padding:20px 0">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</p>';
                return;
            }
            
            allProjects.forEach(prj => {
                const div = document.createElement('div');
                div.className = 'project-item' + (String(prj.id) === String(selectedProjectId) ? ' active' : '');
                div.innerHTML = '<span></span><span class="project-delete">‚úï</span>';
                div.children[0].textContent = prj.name;
                div.children[0].style.flex = '1';
                
                div.children[0].onclick = () => selectProject(prj.id);
                div.children[1].onclick = (e) => { e.stopPropagation(); deleteProject(prj.id); };
                
                list.appendChild(div);
            });
        }

        function selectProject(projectId) {
            document.getElementById('sidebar').classList.remove('mobile-open');
            saveToLocalStorage();
            selectedProjectId = projectId;
            localStorage.setItem('selectedProjectId', String(projectId));
            loadFromLocalStorage();
            renderProjectList();
            updateGeneralInfoDisplay();
            updatePharmacyNumberHeader();
            updateStaffGrid();
            updateResponsibleSelect();
            updatePlanGrid();
            updateStats();
        }

        function createProject() {
            // Close sidebar on mobile
            document.getElementById('sidebar').classList.remove('mobile-open');

            const newProject = {
                id: Date.now(),
                name: '–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç',
                generalInfo: {
                    pharmacyNumber: '',
                    legalEntity: '',
                    address: '',
                    workingHours: '',
                    rentalInfo: '',
                    documentsLink: ''
                },
                staffList: JSON.parse(JSON.stringify(templateStaff)),
                planList: JSON.parse(JSON.stringify(templateTasks))
            };

            allProjects.push(newProject);
            selectedProjectId = newProject.id;

            saveToFirebase();
            localStorage.setItem('selectedProjectId', String(selectedProjectId));

            loadFromLocalStorage();
            renderProjectList();
            updateGeneralInfoDisplay();
            updatePharmacyNumberHeader();
            updateStaffGrid();
            updateResponsibleSelect();
            updatePlanGrid();
            updateStats();

            openGeneralInfoModal();
        }

        function deleteProject(projectId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?')) {
                allProjects = allProjects.filter(p => p.id !== projectId);
                
                if (selectedProjectId === projectId) {
                    selectedProjectId = allProjects.length > 0 ? allProjects[0].id : null;
                }
                
                saveToFirebase();
                localStorage.setItem('selectedProjectId', selectedProjectId ? String(selectedProjectId) : '');
                
                loadFromLocalStorage();
                renderProjectList();
                updateGeneralInfoDisplay();
                updatePharmacyNumberHeader();
                updateStaffGrid();
                updateResponsibleSelect();
                updatePlanGrid();
                updateStats();
            }
        }

        function updatePharmacyNumberHeader() {
            const headerSpan = document.getElementById('pharmacyNumberSpan');
            if (generalInfo.pharmacyNumber) {
                headerSpan.textContent = generalInfo.pharmacyNumber;
            } else {
                headerSpan.textContent = '–ù–µ –≤—ã–±—Ä–∞–Ω–∞';
            }
        }

        function loadFromLocalStorage() {
            if (!selectedProjectId || allProjects.length === 0) {
                generalInfo = {};
                staffList = JSON.parse(JSON.stringify(templateStaff));
                planList = JSON.parse(JSON.stringify(templateTasks));
                updatePharmacyNumberHeader();
                return;
            }
            
            const project = allProjects.find(p => p.id == selectedProjectId);
            if (project) {
                generalInfo = project.generalInfo || {};
                staffList = project.staffList || JSON.parse(JSON.stringify(templateStaff));
                planList = project.planList || JSON.parse(JSON.stringify(templateTasks));
            } else {
                generalInfo = {};
                staffList = JSON.parse(JSON.stringify(templateStaff));
                planList = JSON.parse(JSON.stringify(templateTasks));
            }
            
            updatePharmacyNumberHeader();
        }

        function saveToLocalStorage() {
            if (!selectedProjectId || allProjects.length === 0) return;
            
            const projectIndex = allProjects.findIndex(p => p.id == selectedProjectId);
            if (projectIndex >= 0) {
                allProjects[projectIndex].generalInfo = generalInfo;
                allProjects[projectIndex].staffList = staffList;
                allProjects[projectIndex].planList = planList;
                
                saveToFirebase();
            }
        }

        function toggleHideCompleted() {
            hideCompleted = !hideCompleted;
            const btn = document.getElementById('hideCompletedBtn');
            if (hideCompleted) {
                btn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ';
            } else {
                btn.textContent = '–°–∫—Ä—ã—Ç—å –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ';
            }
            updatePlanGrid();
        }

        function openGeneralInfoModal() {
            document.getElementById('pharmacyNumber').value = generalInfo.pharmacyNumber || '';
            document.getElementById('legalEntity').value = generalInfo.legalEntity || '';
            document.getElementById('pharmacyAddress').value = generalInfo.address || '';
            document.getElementById('workingHours').value = generalInfo.workingHours || '';
            document.getElementById('rentalInfo').value = generalInfo.rentalInfo || '';
            document.getElementById('documentsLink').value = generalInfo.documentsLink || '';
            document.getElementById('generalInfoModal').style.display = 'block';
        }

        function closeGeneralInfoModal() {
            document.getElementById('generalInfoModal').style.display = 'none';
        }

        function saveGeneralInfo() {
            generalInfo = {
                pharmacyNumber: document.getElementById('pharmacyNumber').value,
                legalEntity: document.getElementById('legalEntity').value,
                address: document.getElementById('pharmacyAddress').value,
                workingHours: document.getElementById('workingHours').value,
                rentalInfo: document.getElementById('rentalInfo').value,
                documentsLink: document.getElementById('documentsLink').value
            };

            if (generalInfo.pharmacyNumber && selectedProjectId) {
                const projectIndex = allProjects.findIndex(p => p.id == selectedProjectId);
                if (projectIndex >= 0) {
                    allProjects[projectIndex].name = generalInfo.pharmacyNumber;
                }
            }

            updateGeneralInfoDisplay();
            updatePharmacyNumberHeader();
            closeGeneralInfoModal();
            saveToLocalStorage();
            renderProjectList();
        }

        function clearGeneralInfo() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–± –∞–ø—Ç–µ–∫–µ?')) {
                document.getElementById('pharmacyNumber').value = '';
                document.getElementById('legalEntity').value = '';
                document.getElementById('pharmacyAddress').value = '';
                document.getElementById('workingHours').value = '';
                document.getElementById('rentalInfo').value = '';
                document.getElementById('documentsLink').value = '';
            }
        }

        function updateGeneralInfoDisplay() {
            const content = document.getElementById('generalInfoContent');
            if (Object.keys(generalInfo).length > 0 && (generalInfo.pharmacyNumber || generalInfo.legalEntity || generalInfo.address || generalInfo.workingHours || generalInfo.rentalInfo)) {
                let docsButton = '';
                if (generalInfo.documentsLink) {
                    docsButton = `<p style="margin-top: 15px;"><a href="${generalInfo.documentsLink}" target="_blank" style="display: inline-block; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 10px 16px; border-radius: 6px; text-decoration: none; font-weight: 600; cursor: pointer;">üìÑ –û—Ç–∫—Ä—ã—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã</a></p>`;
                }
                content.innerHTML = `
                    <div style="font-size: 14px; color: #4a5568;">
                        <p><strong>–ù–æ–º–µ—Ä –∞–ø—Ç–µ–∫–∏:</strong> ${generalInfo.pharmacyNumber || '-'}</p>
                        <p><strong>–Æ—Ä.–ª–∏—Ü–æ:</strong> ${generalInfo.legalEntity || '-'}</p>
                        <p><strong>–ê–¥—Ä–µ—Å:</strong> ${generalInfo.address || '-'}</p>
                        <p><strong>–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:</strong> ${generalInfo.workingHours || '-'}</p>
                        <p><strong>–ê—Ä–µ–Ω–¥–∞, –∫–æ–Ω—Ç.–¥–∞–Ω–Ω—ã–µ:</strong> ${generalInfo.rentalInfo || '-'}</p>
                        ${docsButton}
                    </div>
                `;
            } else {
                content.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 30px 0;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
            }
        }

        function openStaffModal() {
            editingStaffId = null;
            document.getElementById('staffModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞';
            document.getElementById('staffPosition').value = '';
            document.getElementById('staffName').value = '';
            document.getElementById('staffEmail').value = '';
            document.getElementById('staffPhone').value = '';
            document.getElementById('staffButtonGroup').innerHTML = `
                <button class="btn-primary" onclick="addStaff()">–î–æ–±–∞–≤–∏—Ç—å</button>
                <button class="btn-secondary" onclick="closeStaffModal()">–û—Ç–º–µ–Ω–∞</button>
            `;
            document.getElementById('staffModal').style.display = 'block';
        }

        function closeStaffModal() {
            document.getElementById('staffModal').style.display = 'none';
        }

        function editStaff(id) {
            editingStaffId = id;
            const staff = staffList.find(s => s.id === id);
            if (staff) {
                document.getElementById('staffModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞';
                document.getElementById('staffPosition').value = staff.position;
                document.getElementById('staffName').value = staff.name;
                document.getElementById('staffEmail').value = staff.email;
                document.getElementById('staffPhone').value = staff.phone;
                document.getElementById('staffButtonGroup').innerHTML = `
                    <button class="btn-primary" onclick="saveEditedStaff()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn-danger" onclick="deleteStaff(${id})">–£–¥–∞–ª–∏—Ç—å</button>
                `;
                document.getElementById('staffModal').style.display = 'block';
            }
        }

        function addStaff() {
            const staff = {
                id: Date.now(),
                position: document.getElementById('staffPosition').value,
                name: document.getElementById('staffName').value,
                email: document.getElementById('staffEmail').value,
                phone: document.getElementById('staffPhone').value
            };

            if (staff.position && staff.name && staff.email) {
                staffList.push(staff);
                updateStaffGrid();
                updateResponsibleSelect();
                closeStaffModal();
                saveToLocalStorage();
            }
        }

        function saveEditedStaff() {
            const staff = staffList.find(s => s.id === editingStaffId);
            if (staff) {
                staff.position = document.getElementById('staffPosition').value;
                staff.name = document.getElementById('staffName').value;
                staff.email = document.getElementById('staffEmail').value;
                staff.phone = document.getElementById('staffPhone').value;
                updateStaffGrid();
                updateResponsibleSelect();
                closeStaffModal();
                saveToLocalStorage();
            }
        }

        function deleteStaff(id) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?')) {
                staffList = staffList.filter(s => s.id !== id);
                updateStaffGrid();
                updateResponsibleSelect();
                closeStaffModal();
                saveToLocalStorage();
            }
        }

        function updateStaffGrid() {
            const grid = document.getElementById('staffGrid');
            if (staffList.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #a0aec0; padding: 30px; grid-column: 1 / -1;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            } else {
                grid.innerHTML = staffList.map((staff) => `
                    <div class="staff-box" onclick="editStaff(${staff.id})">
                        <div class="staff-box-field">
                            <span class="staff-box-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</span>
                            <span class="staff-box-value">${staff.position}</span>
                        </div>
                        <div class="staff-box-field">
                            <span class="staff-box-label">–§–ò–û</span>
                            <span class="staff-box-value">${staff.name}</span>
                        </div>
                        <div class="staff-box-field">
                            <span class="staff-box-label">Email</span>
                            <span class="staff-box-value">${staff.email}</span>
                        </div>
                        <div class="staff-box-field">
                            <span class="staff-box-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                            <span class="staff-box-value">${staff.phone}</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        function updateResponsibleSelect() {
            const select = document.getElementById('taskResponsible');
            const currentValue = select.value;
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</option>';
            
            staffList.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.name;
                option.textContent = staff.name;
                select.appendChild(option);
            });
            
            select.value = currentValue;
        }

        function changeTaskStatus(taskId, currentStatus) {
            const statuses = ['inprogress', 'completed', 'postponed'];
            const currentIndex = statuses.indexOf(currentStatus);
            const nextIndex = (currentIndex + 1) % statuses.length;
            const nextStatus = statuses[nextIndex];
            
            const task = planList.find(t => t.id === taskId);
            if (task) {
                task.status = nextStatus;
                updatePlanGrid();
                updateStats();
                saveToLocalStorage();
            }
        }

        function openPlanModal() {
            editingTaskId = null;
            document.getElementById('planModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –ø–ª–∞–Ω–∞';
            document.getElementById('taskName').value = '';
            document.getElementById('taskResponsible').value = '';
            document.getElementById('taskStatus').value = '';
            document.getElementById('taskComment').value = '';
            document.getElementById('taskDocumentUrl').value = '';
            document.getElementById('planButtonGroup').innerHTML = `
                <button class="btn-primary" id="planSaveBtn" onclick="savePlanTask()">–î–æ–±–∞–≤–∏—Ç—å</button>
                <button class="btn-secondary" onclick="closePlanModal()">–û—Ç–º–µ–Ω–∞</button>
            `;
            document.getElementById('planModal').style.display = 'block';
        }

        function closePlanModal() {
            document.getElementById('planModal').style.display = 'none';
            editingTaskId = null;
        }

        function editTask(id) {
            editingTaskId = id;
            const task = planList.find(t => t.id === id);
            if (task) {
                document.getElementById('planModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É';
                document.getElementById('taskName').value = task.name;
                document.getElementById('taskResponsible').value = task.responsible;
                document.getElementById('taskStatus').value = task.status;
                document.getElementById('taskComment').value = task.comment || '';
                document.getElementById('taskDocumentUrl').value = task.documentUrl || '';
                document.getElementById('planButtonGroup').innerHTML = `
                    <button class="btn-primary" onclick="saveEditedTask()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn-danger" onclick="deleteTask(${id})">–£–¥–∞–ª–∏—Ç—å</button>
                `;
                document.getElementById('planModal').style.display = 'block';
            }
        }

        function savePlanTask() {
            const task = {
                name: document.getElementById('taskName').value,
                responsible: document.getElementById('taskResponsible').value,
                status: document.getElementById('taskStatus').value,
                comment: document.getElementById('taskComment').value,
                documentUrl: document.getElementById('taskDocumentUrl').value || null
            };

            if (task.name && task.responsible && task.status) {
                planList.push({ id: Date.now(), ...task });
                updatePlanGrid();
                closePlanModal();
                updateStats();
                saveToLocalStorage();
            }
        }

        function saveEditedTask() {
            const task = planList.find(t => t.id === editingTaskId);
            if (task) {
                task.name = document.getElementById('taskName').value;
                task.responsible = document.getElementById('taskResponsible').value;
                task.status = document.getElementById('taskStatus').value;
                task.comment = document.getElementById('taskComment').value;
                task.documentUrl = document.getElementById('taskDocumentUrl').value || null;
                updatePlanGrid();
                closePlanModal();
                updateStats();
                saveToLocalStorage();
            }
        }

        function deleteTask(id) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) {
                planList = planList.filter(t => t.id !== id);
                updatePlanGrid();
                updateStats();
                closeStaffModal();
                saveToLocalStorage();
            }
        }

        function updatePlanGrid() {
            const grid = document.getElementById('tasksGrid');
            const isMobile = window.innerWidth < 1024;

            if (planList.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #a0aec0; padding: 30px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
                return;
            }

            grid.innerHTML = planList.map((task, index) => {
                const isCompleted = task.status === 'completed';
                const shouldHide = hideCompleted && isCompleted ? 'hidden-task' : '';
                const titleStyle = isCompleted ? 'text-decoration: line-through; opacity: 0.6;' : '';

                const docLinkHtml = task.documentUrl ? `<a href="${task.documentUrl}" target="_blank" class="pc-doc-link" onclick="event.stopPropagation()" title="–û—Ç–∫—Ä—ã—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç" style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: rgba(0, 102, 204, 0.3); color: #0066cc; border-radius: 6px; text-decoration: none; font-size: 16px; flex-shrink: 0; transition: all 0.2s; border: 1px solid rgba(0, 102, 204, 0.5);">üìÑ</a>` : '';

                const hasComment = task.comment && task.comment.trim();
                const commentHtml = hasComment ? `
                <div style="padding: 8px 16px; background: #fafbfc; border: 1px solid #e5e7eb; border-radius: 6px; width: 100%; color: #718096; font-size: 12px; line-height: 1.5; word-break: break-word; overflow-wrap: break-word; white-space: normal; margin-top: 8px;">
                    <strong style="color: #a0aec0;">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${task.comment}
                </div>` : '';

                if (isMobile) {
                    const boxClass = isCompleted ? 'task-box status-completed-box' : 'task-box';
                    return `
                    <div class="${boxClass} ${shouldHide}" onclick="editTask(${task.id})">
                        <div class="task-box-header-row">
                            <div class="task-box-title-section">
                                <div class="task-box-number">${index + 1}</div>
                                <div class="task-box-title" style="${titleStyle}">${task.name}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                ${docLinkHtml}
                                <span class="status-badge status-${task.status}" style="cursor: pointer;" onclick="event.stopPropagation(); changeTaskStatus(${task.id}, '${task.status}')">
                                    ${getStatusLabel(task.status)}
                                </span>
                            </div>
                        </div>
                        <div class="task-box-field">
                            <span class="task-box-label">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</span>
                            <span class="task-box-value">${task.responsible}</span>
                        </div>
                        ${commentHtml}
                    </div>
                    `;
                } else {
                    const docLink = task.documentUrl ? `<a href="${task.documentUrl}" target="_blank" class="pc-doc-link" onclick="event.stopPropagation()" title="–û—Ç–∫—Ä—ã—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç" style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: rgba(0, 102, 204, 0.3); color: #0066cc; border-radius: 6px; text-decoration: none; font-size: 16px; flex-shrink: 0; transition: all 0.2s; border: 1px solid rgba(0, 102, 204, 0.5);">üìÑ</a>` : '<div style="width: 32px; height: 32px; flex-shrink: 0;"></div>';

                    let taskHtml = `
                    <div class="task-row-pc ${shouldHide}" onclick="editTask(${task.id})" style="cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; gap: 0; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: white; border: 1px solid #e5e7eb; border-radius: 6px 6px 0 0; width: 100%;">
                            <div style="flex-shrink: 0; font-size: 18px; cursor: pointer; user-select: none;" onclick="event.stopPropagation(); changeTaskStatus(${task.id}, '${task.status}')">
                                ${isCompleted ? '‚úÖ' : '‚óã'}
                            </div>
                            <div style="flex-shrink: 0; font-weight: 700; color: #10b981; min-width: 28px; text-align: center;">${index + 1}</div>
                            <div style="flex: 1; font-weight: 600; color: #2d3748; ${titleStyle}; word-break: break-word; overflow-wrap: break-word;">${task.name}</div>
                            <div style="flex-shrink: 0; color: #718096; font-size: 13px; min-width: 140px; text-align: left;">${task.responsible}</div>
                            ${docLink}
                            <span class="status-badge status-${task.status}" style="flex-shrink: 0; cursor: pointer; padding: 4px 12px;" onclick="event.stopPropagation(); changeTaskStatus(${task.id}, '${task.status}')">
                                ${getStatusLabel(task.status)}
                            </span>
                        </div>`;

                    if (task.comment && task.comment.trim()) {
                        taskHtml += `
                        <div style="padding: 8px 16px; background: #fafbfc; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 6px 6px; width: 100%; color: #718096; font-size: 12px; line-height: 1.5; word-break: break-word; overflow-wrap: break-word; white-space: normal;">
                            <strong style="color: #a0aec0;">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${task.comment}
                        </div>`;
                    }

                    taskHtml += `</div>`;
                    return taskHtml;
                }
            }).join('');
        }
        function getStatusLabel(status) {
            const labels = {
                'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
                'inprogress': '–í —Ä–∞–±–æ—Ç–µ',
                'postponed': '–û—Ç–ª–æ–∂–µ–Ω–æ'
            };
            return labels[status] || status;
        }

        function updateStats() {
            const total = planList.length;
            const completed = planList.filter(t => t.status === 'completed').length;
            const inProgress = planList.filter(t => t.status === 'inprogress').length;
            const postponed = planList.filter(t => t.status === 'postponed').length;

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('inProgressTasks').textContent = inProgress;
            document.getElementById('postponedTasks').textContent = postponed;

            const progressPercent = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('progressPercent').textContent = progressPercent + '%';
            document.getElementById('progressFill').style.width = progressPercent + '%';
        }

        window.onclick = function(event) {
            const generalModal = document.getElementById('generalInfoModal');
            const staffModal = document.getElementById('staffModal');
            const planModal = document.getElementById('planModal');
            const templateModal = document.getElementById('templateModal');

            if (event.target === generalModal) {
                generalModal.style.display = 'none';
            }
            if (event.target === staffModal) {
                staffModal.style.display = 'none';
            }
            if (event.target === planModal) {
                planModal.style.display = 'none';
            }
            if (event.target === templateModal) {
                templateModal.style.display = 'none';
            }
        }

        document.getElementById('newProjectBtn').onclick = createProject;
        document.getElementById('editTemplateBtn').onclick = openTemplateModal;

        window.addEventListener('DOMContentLoaded', function() {
            initFirebaseSync();
            renderProjectList();
            loadFromLocalStorage();
            updateGeneralInfoDisplay();
            updatePharmacyNumberHeader();
            updateStaffGrid();
            updateResponsibleSelect();
            updatePlanGrid();
            updateStats();
        });
    </script>

    <script>
        // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–∞–π–¥–±–∞—Ä–∞
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('mobile-open');
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —Å–∞–π–¥–±–∞—Ä–∞
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleBtn');

            if (window.innerWidth <= 768) {
                if (!sidebar.contains(event.target) && !toggleBtn.contains(event.target)) {
                    sidebar.classList.remove('mobile-open');
                }
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth > 768) {
                sidebar.classList.remove('mobile-open');
            }
        });
    </script>
</body>
</html>